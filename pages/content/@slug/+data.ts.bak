import type { PageContextServer } from 'vike/types'
import { getContentSlugs } from '../../../src/content/mdx'

export async function data(pageContext: PageContextServer) {
  const slug = pageContext.routeParams?.slug
  if (!slug) return { mdx: null }

  // Load all MDX under /content
  const modules = import.meta.glob('../../../content/**/*.mdx')

  // For flat files: content/drop-001.mdx -> /content/drop-001
  // Also supports: content/drop-001/index.mdx -> /content/drop-001
  const match = Object.keys(modules).find(
    (p) => p.endsWith(`/content/${slug}.mdx`) || p.endsWith(`/content/${slug}/index.mdx`)
  )

  if (!match) return { mdx: null }

  const mod: any = await (modules as any)[match]()
  return { mdx: mod.default }
}

export function prerender() {
  return getContentSlugs().map((slug) => `/content/${slug}`)
}
